<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>C# Wasm MMO Client</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        canvas { display: block; }
        #ui {
            position: absolute; top: 10px; left: 10px;
            color: #00ff00; font-family: monospace; font-size: 16px;
            pointer-events: none; user-select: none;
            text-shadow: 1px 1px 2px black;
        }
    </style>
</head>
<body>
    <div id="ui">Booting System...</div>

    <script type='module'>
        import { dotnet } from './_framework/dotnet.js'

        // ---------------------------------------------------------
        // Three.js を安全にロードする関数 (ハッシュ検証・キャッシュ対策版)
        // ---------------------------------------------------------
        async function loadSecureThreeJS() {
            let fileName = "three.module.js";
            let expectedHash = "";

            try {
                // 1. ハッシュ設定ファイルを取得 (★重要：キャッシュさせない設定)
                const hashResponse = await fetch('./Three.js_hash.txt', { cache: "no-store" });
                
                if (hashResponse.ok) {
                    const text = await hashResponse.text();
                    expectedHash = text.trim();
                    if (expectedHash) {
                        fileName = `three.${expectedHash}.js`;
                        console.log(`[Loader] Target: ${fileName}`);
                    }
                }
            } catch (e) {
                console.warn("[Loader] Hash config not found. Using default.");
            }

            // 2. ライブラリ本体を取得
            const response = await fetch(`./${fileName}`);
            if (!response.ok) throw new Error(`Library missing: ${fileName}`);
            
            const arrayBuffer = await response.arrayBuffer();

            // 3. 改ざん検知 (Integrity Check)
            if (expectedHash) {
                const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const calculated = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                if (expectedHash !== calculated) {
                    alert("【セキュリティ警告】\nライブラリが改ざんされています！起動を中止します。");
                    throw new Error("Security Alert: Hash mismatch!");
                }
                console.log("[Loader] Integrity Check: PASS");
            }

            // 4. 読み込み
            const textDecoder = new TextDecoder("utf-8");
            const scriptContent = textDecoder.decode(arrayBuffer);
            const blob = new Blob([scriptContent], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            
            const THREE = await import(url);
            URL.revokeObjectURL(url);
            return THREE;
        }

        // ---------------------------------------------------------
        // メイン処理
        // ---------------------------------------------------------
        try {
            // A. C# ランタイム起動
            const { getAssemblyExports, getConfig } = await dotnet.create();
            const config = getConfig();
            const exports = await getAssemblyExports(config.mainAssemblyName);
            const CSharp = exports.MyGame.MyFunctions;

            // B. Three.js 起動
            const THREE = await loadSecureThreeJS();

            // C. 3Dシーン構築
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // ライト
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(5, 10, 7);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0x404040));

            // プレイヤー (緑のキューブ)
            const geometry = new THREE.BoxGeometry();
            const material = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
            const playerCube = new THREE.Mesh(geometry, material);
            scene.add(playerCube);

            camera.position.z = 5;
            document.getElementById("ui").innerText = "System Online. " + CSharp.GetGreeting();

            // D. ゲームループ
            function animate() {
                requestAnimationFrame(animate);

                try {
                    // C#に計算させる
                    const rot = CSharp.UpdateFrame();
                    playerCube.rotation.x = rot;
                    playerCube.rotation.y = rot;
                } catch (e) { /* C#ロード待ちなどでエラーが出ないように */ }

                renderer.render(scene, camera);
            }
            animate();

            // リサイズ対応
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

        } catch (err) {
            document.getElementById("ui").innerText = "FATAL ERROR: " + err.message;
            document.getElementById("ui").style.color = "red";
            console.error(err);
        }
    </script>
</body>
</html>